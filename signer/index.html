<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Celo Superchain Ops - Council Signer</title>
  <style>
    :root {
      --primary: #35D07F;
      --primary-dark: #2BB56A;
      --bg: #FAFAFA;
      --card: #FFFFFF;
      --text: #1A1A1A;
      --text-secondary: #666666;
      --border: #E5E5E5;
      --error: #DC3545;
      --success: #28A745;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 1.5rem 0;
    }
    header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    header .version {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .card-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
    }
    .status.disconnected {
      background: #FEF3F2;
      color: #B42318;
    }
    .status.connected {
      background: #ECFDF3;
      color: #027A48;
    }
    .status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }
    .address {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.8125rem;
      word-break: break-all;
    }
    details {
      margin-top: 0;
    }
    details.card-details {
      margin-top: 0;
    }
    summary {
      font-size: 0.875rem;
      color: var(--text);
      cursor: pointer;
      padding: 0.75rem 0;
      font-weight: 500;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    summary::-webkit-details-marker {
      display: none;
    }
    summary::before {
      content: '▶';
      font-size: 0.625rem;
      transition: transform 0.2s;
    }
    details[open] summary::before {
      transform: rotate(90deg);
    }
    .details-content {
      padding: 0.75rem 0;
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    .detail-row {
      display: flex;
      flex-direction: column;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    .detail-value {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.75rem;
      word-break: break-all;
    }
    button {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary {
      background: var(--primary);
      color: white;
    }
    button.primary:hover {
      background: var(--primary-dark);
    }
    button.primary:disabled {
      background: #CCC;
      cursor: not-allowed;
    }
    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    button.secondary:hover {
      background: var(--bg);
    }
    .btn-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .btn-group button {
      flex: 1;
    }
    .output-box {
      background: #1A1A1A;
      color: #E5E5E5;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.75rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }
    .error {
      background: #FEF3F2;
      color: #B42318;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .success {
      background: #ECFDF3;
      color: #027A48;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .hidden { display: none !important; }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    footer {
      text-align: center;
      padding: 2rem 0;
      color: var(--text-secondary);
      font-size: 0.75rem;
    }
    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    /* Tab styles */
    .tab-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: var(--bg);
      padding: 4px;
      border-radius: 10px;
    }
    .tab-btn {
      flex: 1;
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
      color: var(--text-secondary);
      transition: all 0.2s;
      width: auto;
    }
    .tab-btn.active {
      background: var(--card);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tab-btn:hover:not(.active) {
      color: var(--text);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Steps list */
    .steps-list {
      list-style: none;
      counter-reset: step;
    }
    .steps-list li {
      position: relative;
      padding-left: 2rem;
      margin-bottom: 0.875rem;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .steps-list li::before {
      counter-increment: step;
      content: counter(step);
      position: absolute;
      left: 0;
      top: 0;
      width: 1.5rem;
      height: 1.5rem;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .steps-list li:last-child {
      margin-bottom: 0;
    }

    /* Checklist */
    .checklist {
      list-style: none;
      margin: 0.75rem 0;
    }
    .checklist li {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.8125rem;
      line-height: 1.5;
    }
    .checklist li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: var(--primary);
      font-weight: 600;
    }

    /* Link styles */
    .link {
      color: var(--primary);
      text-decoration: none;
      word-break: break-all;
    }
    .link:hover {
      text-decoration: underline;
    }

    /* Code inline */
    code {
      background: var(--bg);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.75rem;
    }

    /* Info box */
    .info-box {
      background: #F0F9FF;
      border-left: 3px solid #0EA5E9;
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      font-size: 0.8125rem;
      margin-top: 1rem;
      color: #0C4A6E;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Celo Superchain Ops</h1>
      <div class="version">Council Signer — succinct-v102</div>
    </header>

    <div id="error-msg" class="error hidden"></div>
    <div id="success-msg" class="success hidden"></div>

    <!-- Before You Sign Instructions -->
    <div class="card">
      <div class="card-title">Before You Sign</div>
      <div class="tab-container">
        <button class="tab-btn active" data-tab="mobile">Mobile</button>
        <button class="tab-btn" data-tab="pc">PC</button>
      </div>

      <div id="tab-mobile" class="tab-content active">
        <ol class="steps-list">
          <li>Pair <strong>Ledger Nano X</strong> with your phone via Bluetooth</li>
          <li>Unlock Ledger and open the <strong>Ethereum</strong> app</li>
          <li>Open <strong>MetaMask</strong> mobile app</li>
          <li>Ensure your Ledger account is connected in MetaMask</li>
          <li>Open this page in MetaMask's built-in browser</li>
          <li>Tap <strong>Connect</strong> below and approve in MetaMask</li>
        </ol>
      </div>

      <div id="tab-pc" class="tab-content">
        <ol class="steps-list">
          <li>Connect <strong>Ledger Nano X</strong> via Bluetooth (preferred) or USB</li>
          <li>Unlock Ledger and open the <strong>Ethereum</strong> app</li>
          <li>Open <strong>MetaMask</strong> browser extension</li>
          <li>Ensure your Ledger account is selected</li>
          <li>Click <strong>Connect</strong> below and approve in MetaMask</li>
        </ol>
      </div>

      <div class="info-box">
        Bluetooth is the recommended connection method for Ledger Nano X.
      </div>
    </div>

    <!-- What Am I Signing? -->
    <div class="card">
      <details class="card-details">
        <summary>What am I signing?</summary>
        <div class="details-content">
          <p style="margin-bottom: 0.75rem;">
            You are approving an upgrade to <strong>Celo's fault proof system</strong>. This transaction will:
          </p>
          <ul class="checklist">
            <li>Update the OPSuccinctFaultDisputeGame contract to v1.0.2</li>
            <li>Reduce on-chain costs by up to 9x</li>
            <li>Fix potential proving failures for certain blocks</li>
          </ul>
          <p style="margin-top: 0.75rem;">
            Your signature will be collected along with other council members. The upgrade executes only after enough signatures are gathered.
          </p>
        </div>
      </details>
    </div>

    <!-- Verify in Tenderly -->
    <div class="card">
      <details class="card-details">
        <summary>Verify in Tenderly</summary>
        <div class="details-content">
          <p style="margin-bottom: 0.75rem;">
            Review the simulated transaction before signing:
          </p>
          <p style="margin-bottom: 0.75rem;">
            <a class="link" href="https://dashboard.tenderly.co/explorer/vnet/39498d1a-4638-47d3-8bbc-010de8f718ce/tx/0x27f7a467c7d7faa3aa9934ffc2810a4d910e2404783aed427a5fa1f732f7e12d" target="_blank" rel="noopener">
              Open Tenderly Simulation →
            </a>
          </p>
          <p style="margin-bottom: 0.5rem;"><strong>What to check:</strong></p>
          <ul class="checklist">
            <li>Enable "Dev Mode" (toggle in top right corner)</li>
            <li>Navigate to "Storage Changes" tab</li>
            <li>Verify <code>gameImpls[42]</code> updates to <code>0xc5bd...de37</code></li>
            <li>Confirm transaction shows success (green checkmark)</li>
          </ul>
          <p style="margin-top: 0.75rem; font-size: 0.8125rem;">
            <strong>For technical verification:</strong> Run <code>scripts/decode_succinct-v102_calldata.sh</code> in the repo to decode the exact calldata.
          </p>
        </div>
      </details>
    </div>

    <!-- Connection Status -->
    <div class="card">
      <div class="card-title">Wallet</div>
      <div id="status-disconnected" class="status disconnected">
        <span class="dot"></span>
        <span>Not connected</span>
      </div>
      <div id="status-connected" class="status connected hidden">
        <span class="dot"></span>
        <div>
          <div>Connected</div>
          <div id="connected-address" class="address"></div>
        </div>
      </div>
      <button id="btn-connect" class="primary" style="margin-top: 1rem;">
        Connect
      </button>
    </div>

    <!-- Transaction Details -->
    <div class="card">
      <div class="card-title">Transaction to Sign</div>
      <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
        Approve hash for Council Safe to execute parent transaction.
      </div>
      <details>
        <summary style="font-size: 0.8125rem; color: var(--text-secondary);">View transaction details</summary>
        <div class="detail-row">
          <span class="detail-label">Council Safe</span>
          <span class="detail-value">0xC03172263409584f7860C25B6eB4985f0f6F4636</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Parent Safe</span>
          <span class="detail-value">0x4092A77bAF58fef0309452cEaCb09221e556E112</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Council Nonce</span>
          <span class="detail-value">24</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Parent TX Hash</span>
          <span class="detail-value">0xa17db5fb2aa052b03a49ed701483f37fa9e795b7ccbbe6f19905af99e358a54f</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Child TX Hash (signing)</span>
          <span class="detail-value">0xb249f86c808e56add978b80a312200ab5895ae770bef40267bb98e624c6e568e</span>
        </div>
      </details>
    </div>

    <!-- Sign Button -->
    <div class="card">
      <button id="btn-sign" class="primary" disabled>
        Sign Transaction
      </button>
    </div>

    <!-- Output Section -->
    <div id="output-section" class="card hidden">
      <div class="card-title">Signature Result</div>
      <div id="output-json" class="output-box"></div>
      <div class="btn-group">
        <button id="btn-copy" class="secondary">Copy</button>
        <button id="btn-download" class="secondary">Download</button>
      </div>
    </div>

    <footer>
      <a href="https://github.com/celo-org/celo-superchain-ops" target="_blank" rel="noopener">View on GitHub</a>
    </footer>
  </div>

  <script type="module">
    import { createWalletClient, custom } from 'https://esm.sh/viem@2.x'
    import { mainnet } from 'https://esm.sh/viem@2.x/chains'

    // === CONSTANTS ===
    const CONFIG = {
      version: 'succinct-v102',
      councilSafe: '0xC03172263409584f7860C25B6eB4985f0f6F4636',
      parentSafe: '0x4092A77bAF58fef0309452cEaCb09221e556E112',
      councilNonce: 24n,
      parentTxHash: '0xa17db5fb2aa052b03a49ed701483f37fa9e795b7ccbbe6f19905af99e358a54f',
      childTxHash: '0xb249f86c808e56add978b80a312200ab5895ae770bef40267bb98e624c6e568e',
      childTxData: '0x1901006bcc13a9a6b3224caf34092bd0db63b90656971bfec6731c9c61f278a239ad4b66909b1322535195b6fd334364a7b5fe1833cd4ceba233e2c9f5767758d2bb',
      refundReceiver: '0x95ffac468e37ddeef407ffef18f0cc9e86d8f13b',
      gasToken: '0x0000000000000000000000000000000000000000'
    }

    const SAFE_TX_TYPES = {
      SafeTx: [
        { name: 'to', type: 'address' },
        { name: 'value', type: 'uint256' },
        { name: 'data', type: 'bytes' },
        { name: 'operation', type: 'uint8' },
        { name: 'safeTxGas', type: 'uint256' },
        { name: 'baseGas', type: 'uint256' },
        { name: 'gasPrice', type: 'uint256' },
        { name: 'gasToken', type: 'address' },
        { name: 'refundReceiver', type: 'address' },
        { name: 'nonce', type: 'uint256' }
      ]
    }

    // approveHash(bytes32) selector = 0xd4d9bdcd
    const childCalldata = '0xd4d9bdcd' + CONFIG.parentTxHash.slice(2)

    // === STATE ===
    let walletClient = null
    let connectedAddress = null

    // === DOM ELEMENTS ===
    const elements = {
      errorMsg: document.getElementById('error-msg'),
      successMsg: document.getElementById('success-msg'),
      statusDisconnected: document.getElementById('status-disconnected'),
      statusConnected: document.getElementById('status-connected'),
      connectedAddress: document.getElementById('connected-address'),
      btnConnect: document.getElementById('btn-connect'),
      btnSign: document.getElementById('btn-sign'),
      outputSection: document.getElementById('output-section'),
      outputJson: document.getElementById('output-json'),
      btnCopy: document.getElementById('btn-copy'),
      btnDownload: document.getElementById('btn-download')
    }

    // === HELPERS ===
    function showError(msg) {
      elements.errorMsg.textContent = msg
      elements.errorMsg.classList.remove('hidden')
      elements.successMsg.classList.add('hidden')
    }

    function showSuccess(msg) {
      elements.successMsg.textContent = msg
      elements.successMsg.classList.remove('hidden')
      elements.errorMsg.classList.add('hidden')
    }

    function clearMessages() {
      elements.errorMsg.classList.add('hidden')
      elements.successMsg.classList.add('hidden')
    }

    function truncateAddress(addr) {
      return addr.slice(0, 8) + '...' + addr.slice(-6)
    }

    function updateConnectionUI() {
      if (connectedAddress) {
        elements.statusDisconnected.classList.add('hidden')
        elements.statusConnected.classList.remove('hidden')
        elements.connectedAddress.textContent = truncateAddress(connectedAddress)
        elements.btnConnect.textContent = 'Disconnect'
        elements.btnSign.disabled = false
      } else {
        elements.statusDisconnected.classList.remove('hidden')
        elements.statusConnected.classList.add('hidden')
        elements.btnConnect.textContent = 'Connect'
        elements.btnSign.disabled = true
      }
    }

    // === WALLET FUNCTIONS ===
    async function connect() {
      clearMessages()

      if (!window.ethereum) {
        showError('MetaMask not detected. Please install MetaMask or open this page in the MetaMask mobile browser.')
        return
      }

      try {
        elements.btnConnect.disabled = true
        elements.btnConnect.innerHTML = '<span class="spinner"></span>Connecting...'

        // Always use Ethereum Mainnet (Council Safe is on Ethereum)
        walletClient = createWalletClient({
          chain: mainnet,
          transport: custom(window.ethereum)
        })

        const [address] = await walletClient.requestAddresses()
        connectedAddress = address

        // Ensure we're on Ethereum Mainnet
        try {
          const currentChainId = await walletClient.getChainId()
          if (currentChainId !== mainnet.id) {
            await walletClient.switchChain({ id: mainnet.id })
          }
        } catch (switchError) {
          console.warn('Network switch failed:', switchError)
          showError('Please switch to Ethereum Mainnet in MetaMask.')
          return
        }

        updateConnectionUI()
        showSuccess('Wallet connected successfully!')

      } catch (error) {
        console.error('Connection error:', error)
        if (error.code === 4001) {
          showError('Connection request was cancelled.')
        } else {
          showError('Failed to connect. Make sure MetaMask is unlocked.')
        }
      } finally {
        elements.btnConnect.disabled = false
        updateConnectionUI()
      }
    }

    function disconnect() {
      walletClient = null
      connectedAddress = null
      updateConnectionUI()
      elements.outputSection.classList.add('hidden')
      clearMessages()
    }

    async function sign() {
      clearMessages()

      if (!connectedAddress || !walletClient) {
        showError('Please connect your wallet first.')
        return
      }

      try {
        elements.btnSign.disabled = true
        elements.btnSign.innerHTML = '<span class="spinner"></span>Signing...'

        // EIP-712 domain - always chainId 1 because Council Safe is on Ethereum
        const domain = {
          chainId: 1,
          verifyingContract: CONFIG.councilSafe
        }

        // SafeTx message
        const message = {
          to: CONFIG.parentSafe,
          value: 0n,
          data: childCalldata,
          operation: 0, // CALL
          safeTxGas: 0n,
          baseGas: 0n,
          gasPrice: 0n,
          gasToken: CONFIG.gasToken,
          refundReceiver: CONFIG.refundReceiver,
          nonce: CONFIG.councilNonce
        }

        // Sign the typed data
        const signature = await walletClient.signTypedData({
          account: connectedAddress,
          domain,
          types: SAFE_TX_TYPES,
          primaryType: 'SafeTx',
          message
        })

        // Format output to match justfile
        const output = {
          version: CONFIG.version,
          hash: CONFIG.childTxHash,
          data: CONFIG.childTxData,
          sig: signature.slice(2), // Remove 0x prefix
          account: connectedAddress
        }

        // Display result
        elements.outputJson.textContent = JSON.stringify(output, null, 2)
        elements.outputSection.classList.remove('hidden')
        showSuccess('Transaction signed successfully! Download or copy the signature below.')

      } catch (error) {
        console.error('Signing error:', error)
        if (error.code === 4001) {
          showError('Signing was cancelled.')
        } else if (error.message?.includes('Ledger') || error.message?.includes('device')) {
          showError('Ledger error: Make sure your device is unlocked and the Ethereum app is open.')
        } else {
          showError('Failed to sign. Please try again.')
        }
      } finally {
        elements.btnSign.disabled = false
        elements.btnSign.textContent = 'Sign Transaction'
      }
    }

    function copyToClipboard() {
      const text = elements.outputJson.textContent
      navigator.clipboard.writeText(text).then(() => {
        elements.btnCopy.textContent = 'Copied!'
        setTimeout(() => { elements.btnCopy.textContent = 'Copy' }, 2000)
      }).catch(() => {
        showError('Failed to copy to clipboard.')
      })
    }

    function downloadJson() {
      const text = elements.outputJson.textContent
      const blob = new Blob([text], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'out.json'
      a.click()
      URL.revokeObjectURL(url)
    }

    // === TAB SWITCHING ===
    function initTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn')
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.dataset.tab

          // Update button states
          tabBtns.forEach(b => b.classList.remove('active'))
          btn.classList.add('active')

          // Update content visibility
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active')
          })
          document.getElementById(`tab-${tabId}`).classList.add('active')
        })
      })
    }

    // === EVENT LISTENERS ===
    elements.btnConnect.addEventListener('click', () => {
      if (connectedAddress) {
        disconnect()
      } else {
        connect()
      }
    })

    elements.btnSign.addEventListener('click', sign)
    elements.btnCopy.addEventListener('click', copyToClipboard)
    elements.btnDownload.addEventListener('click', downloadJson)

    // Listen for account changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          disconnect()
        } else {
          connectedAddress = accounts[0]
          updateConnectionUI()
        }
      })

      window.ethereum.on('chainChanged', () => {
        // Reload on chain change to ensure consistent state
        window.location.reload()
      })
    }

    // Initialize
    initTabs()
    updateConnectionUI()
  </script>
</body>
</html>
